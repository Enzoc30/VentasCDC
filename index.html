<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoContaLabs - Procesador Final</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f3f4f6;
            --text-dark: #111827;
            --text-gray: #6b7280;
            --card-radius: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-dark);
        }

        .dashboard-card {
            background: white;
            width: 100%;
            max-width: 520px;
            padding: 40px;
            border-radius: var(--card-radius);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            text-align: center;
            animation: floatUp 0.6s ease-out;
        }

        .icon-header {
            background: #eff6ff;
            color: var(--primary);
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px auto;
            font-size: 32px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        p.subtitle {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .upload-zone {
            border: 2px dashed #e5e7eb;
            border-radius: 16px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .upload-zone input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-content i {
            font-size: 28px;
            color: #9ca3af;
            margin-bottom: 10px;
            display: block;
        }

        .upload-content span {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-gray);
        }

        .file-selected {
            color: var(--primary) !important;
            font-weight: 600 !important;
        }

        .btn-process {
            background-color: var(--primary);
            color: white;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 24px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-process:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-process:active {
            transform: translateY(1px);
        }

        .btn-process:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-msg {
            margin-top: 20px;
            font-size: 13px;
            padding: 12px;
            border-radius: 12px;
            display: none;
        }

        .status-loading {
            background: #eff6ff;
            color: var(--primary);
            display: block;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            display: block;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        @keyframes floatUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-card">
        <div class="icon-header">
            <i class="ph ph-file-xls"></i>
        </div>

        <h1>AutoContaLabs</h1>
        <p class="subtitle">Mapeo de Ventas + Validación de Correlativos</p>

        <div class="upload-zone" id="dropZone">
            <div class="upload-content">
                <i class="ph ph-cloud-arrow-up" id="uploadIcon"></i>
                <span id="uploadText">Haz clic para subir tu Excel (Ventas)</span>
            </div>
            <input type="file" id="inputFile" accept=".xlsx, .xls" onchange="actualizarNombreArchivo()">
        </div>

        <button class="btn-process" id="btnProcess" onclick="procesarCompleto()">
            Procesar y Descargar Reporte
        </button>

        <div id="statusArea" class="status-msg"></div>
    </div>

    <script>
        function actualizarNombreArchivo() {
            const input = document.getElementById('inputFile');
            const text = document.getElementById('uploadText');
            const icon = document.getElementById('uploadIcon');

            if (input.files.length > 0) {
                text.innerText = input.files[0].name;
                text.classList.add('file-selected');
                icon.className = "ph ph-check-circle";
                icon.style.color = "var(--primary)";
            }
        }

        function mostrarMensaje(texto, tipo) {
            const status = document.getElementById('statusArea');
            status.innerText = texto;
            status.className = 'status-msg ' + tipo;
        }

        async function procesarCompleto() {
            const fileInput = document.getElementById('inputFile');
            if (fileInput.files.length === 0) {
                mostrarMensaje("Por favor, selecciona un archivo.", "status-error");
                return;
            }

            mostrarMensaje("Procesando datos...", "status-loading");
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);

                    const sheet = workbook.worksheets[0];
                    const data = [];

                    // Nombres de documentos según lógica original
                    const nombresDoc = { "01": "FACTURA", "03": "BOLETA DE VENTA", "07": "NOTA DE CRÉDITO" };

                    // 1. Cargar Datos (Header 10 -> Fila 11 en ExcelJS)
                    // Las columnas originales son D (4), E (5), F (6)
                    sheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 11) {
                            data.push({
                                tipo: String(row.getCell(4).value || "").trim(),
                                serie: String(row.getCell(5).value || "").trim(),
                                numero: parseInt(row.getCell(6).value)
                            });
                        }
                    });

                    // 2. Filtrar como en Python: r'^0\d+$' y No Nulos
                    let df = data.filter(d => /^0\d+$/.test(d.tipo) && !isNaN(d.numero));

                    const observaciones = [];
                    const completos = [];

                    // 3. Tipos Únicos
                    const tiposUnicos = [...new Set(df.map(d => d.tipo))].sort();

                    tiposUnicos.forEach(tipo => {
                        const nombreT = nombresDoc[tipo] || "OTRO";
                        const dfTipo = df.filter(d => d.tipo === tipo);
                        const seriesExistentes = [...new Set(dfTipo.map(d => d.serie))].sort();

                        // Validar Saltos de Series
                        if (seriesExistentes.length > 0) {
                            const matchPref = seriesExistentes[0].match(/([A-Z]+)(\d+)/);
                            if (matchPref) {
                                const pref = matchPref[1];
                                const numsS = seriesExistentes.map(s => {
                                    const m = s.match(/\d+/);
                                    return m ? parseInt(m[0]) : null;
                                }).filter(n => n !== null);

                                const minS = Math.min(...numsS);
                                const maxS = Math.max(...numsS);

                                for (let i = minS; i <= maxS; i++) {
                                    const sTeorica = pref + String(i).padStart(2, '0');
                                    if (!seriesExistentes.includes(sTeorica)) {
                                        observaciones.append
                                        observaciones.push({
                                            NIVEL: "SERIE", TIPO: tipo, DESCRIPCION: nombreT,
                                            DETALLE: "Falta serie completa", SERIE: sTeorica, NUMERO: "N/A"
                                        });
                                    }
                                }
                            }
                        }

                        // Validar Saltos de Números
                        seriesExistentes.forEach(serie => {
                            const dfSerie = dfTipo.filter(d => d.serie === serie).sort((a, b) => a.numero - b.numero);
                            const numeros = dfSerie.map(d => d.numero);
                            const minN = Math.min(...numeros);
                            const maxN = Math.max(...numeros);
                            const setN = new Set(numeros);

                            let faltantes = [];
                            for (let n = minN; n <= maxN; n++) {
                                if (!setN.has(n)) faltantes.push(n);
                            }

                            if (faltantes.length === 0) {
                                completos.push({
                                    TIPO_OK: tipo, DOC_OK: nombreT, SERIE_COMPLETA: serie, RANGO: `${minN} al ${maxN}`
                                });
                            } else {
                                faltantes.forEach(f => {
                                    observaciones.push({
                                        NIVEL: "NÚMERO", TIPO: tipo, DESCRIPCION: nombreT,
                                        DETALLE: "Falta correlativo", SERIE: serie, NUMERO: f
                                    });
                                });
                            }
                        });
                    });

                    // 4. Generar Nuevo Excel (ExcelWriter alternativo)
                    const outWorkbook = new ExcelJS.Workbook();
                    const outSheet = outWorkbook.addWorksheet('OBSERVACIONES');

                    // Escribir Tabla Observaciones (A1)
                    const headerObs = ["NIVEL", "TIPO", "DESCRIPCION", "DETALLE", "SERIE", "NUMERO"];
                    outSheet.addRow(headerObs);
                    observaciones.forEach(obs => {
                        outSheet.addRow([obs.NIVEL, obs.TIPO, obs.DESCRIPCION, obs.DETALLE, obs.SERIE, obs.NUMERO]);
                    });

                    // Escribir Tabla Completos (Columna H = 8, Fila 4 = startrow 3)
                    const startColComp = 8;
                    const startRowComp = 4;
                    const headerComp = ["TIPO_OK", "DOC_OK", "SERIE_COMPLETA", "RANGO"];

                    headerComp.forEach((h, idx) => {
                        outSheet.getCell(startRowComp, startColComp + idx).value = h;
                    });

                    completos.forEach((comp, rowIdx) => {
                        const r = startRowComp + 1 + rowIdx;
                        outSheet.getCell(r, startColComp).value = comp.TIPO_OK;
                        outSheet.getCell(r, startColComp + 1).value = comp.DOC_OK;
                        outSheet.getCell(r, startColComp + 2).value = comp.SERIE_COMPLETA;
                        outSheet.getCell(r, startColComp + 3).value = comp.RANGO;
                    });

                    // Guardar
                    const buffer = await outWorkbook.xlsx.writeBuffer();
                    saveAs(new Blob([buffer]), "Reporte_Ventas_Jerarquico.xlsx");
                    mostrarMensaje("¡Proceso completado con éxito!", "status-success");

                } catch (err) {
                    console.error(err);
                    mostrarMensaje("Error procesando el archivo. Verifica el formato.", "status-error");
                }
            };

            reader.readAsArrayBuffer(file);
        }
    </script>
</body>

</html>