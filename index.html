<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Registros SUNAT</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-xl">
        <h1 class="text-2xl font-bold mb-4 text-blue-600">Procesador de Observaciones Excel</h1>
        <p class="mb-6 text-gray-600">Sube tu archivo <code class="bg-gray-200 px-1">R.V.12.2025.xlsx</code> para
            generar la hoja de observaciones.</p>

        <div class="border-2 border-dashed border-gray-300 p-8 text-center rounded-lg mb-4">
            <input type="file" id="file-upload" class="mb-4" accept=".xlsx">
            <button id="process-btn"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded hidden">
                Procesar y Descargar
            </button>
        </div>

        <div id="output" class="text-sm text-gray-700 mt-4 p-4 bg-gray-50 rounded hidden"></div>
    </div>

    <py-config>
        packages = ["pandas", "openpyxl", "re"]
    </py-config>

    <script type="py">
        from pyscript import display, when
        import pandas as pd
        import re
        import io
        from js import Uint8Array, File, URL, document
        import openpyxl

        @when("change", "#file-upload")
        async def file_selected(event):
            document.getElementById("process-btn").classList.remove("hidden")

        @when("click", "#process-btn")
        async def run_process(event):
            output_div = document.getElementById("output")
            output_div.classList.remove("hidden")
            output_div.innerHTML = "Procesando... por favor espera."
            
            file_list = document.getElementById("file-upload").files
            if len(file_list) == 0: return
            
            # Leer archivo
            file = file_list.item(0)
            array_buffer = await file.arrayBuffer()
            content = array_buffer.to_py()
            
            # 1. LÓGICA DE TU CÓDIGO
            input_io = io.BytesIO(content)
            df = pd.read_excel(input_io, header=10)
            df.columns = df.columns.str.replace('\n', ' ').str.strip()

            nombres_doc = {"01": "FACTURA", "03": "BOLETA DE VENTA", "07": "NOTA DE CRÉDITO"}
            col_tipo, col_serie, col_num = df.columns[3], df.columns[4], df.columns[5]

            df = df[df[col_tipo].astype(str).str.match(r'^0\d+$', na=False)].copy()
            df[col_num] = pd.to_numeric(df[col_num], errors='coerce')
            df = df.dropna(subset=[col_num])
            df[col_num] = df[col_num].astype(int)

            observaciones, completos = [], []
            tipos_unicos = sorted(df[col_tipo].unique())

            for tipo in tipos_unicos:
                nombre_t = nombres_doc.get(str(tipo), "OTRO")
                df_tipo = df[df[col_tipo] == tipo]
                series_existentes = sorted(df_tipo[col_serie].unique())

                if series_existentes:
                    match_pref = re.match(r'([A-Z]+)(\d+)', str(series_existentes[0]))
                    if match_pref:
                        pref = match_pref.group(1)
                        nums_s = [int(re.search(r'\d+', s).group()) for s in series_existentes]
                        for i in range(min(nums_s), max(nums_s) + 1):
                            s_teorica = f"{pref}{str(i).zfill(2)}"
                            if s_teorica not in series_existentes:
                                observaciones.append({"NIVEL": "SERIE", "TIPO": tipo, "DESCRIPCION": nombre_t, "DETALLE": "Falta serie completa", "SERIE": s_teorica, "NUMERO": "N/A"})

                for serie in series_existentes:
                    df_serie = df_tipo[df_tipo[col_serie] == serie].sort_values(by=col_num)
                    numeros = df_serie[col_num].tolist()
                    min_n, max_n = min(numeros), max(numeros)
                    set_n = set(numeros)
                    faltantes = [n for n in range(min_n, max_n + 1) if n not in set_n]
                    
                    if not faltantes:
                        completos.append({"TIPO_OK": tipo, "DOC_OK": nombre_t, "SERIE_COMPLETA": serie, "RANGO": f"{min_n} al {max_n}"})
                    else:
                        for f in faltantes:
                            observaciones.append({"NIVEL": "NÚMERO", "TIPO": tipo, "DESCRIPCION": nombre_t, "DETALLE": "Falta correlativo", "SERIE": serie, "NUMERO": f})

            # 2. GUARDAR (Preservando original)
            output_io = io.BytesIO()
            # Para preservar el original en la web, cargamos el original y añadimos la hoja
            input_io.seek(0)
            with pd.ExcelWriter(output_io, engine='openpyxl') as writer:
                # Escribimos el original de nuevo (en la web es más fácil reconstruir las hojas necesarias)
                pd.read_excel(input_io).to_excel(writer, sheet_name='Hoja1', index=False)
                pd.DataFrame(observaciones).to_excel(writer, sheet_name='OBSERVACIONES', index=False)
                pd.DataFrame(completos).to_excel(writer, sheet_name='OBSERVACIONES', startcol=7, startrow=3, index=False)

            # 3. DESCARGAR
            output_div.innerHTML = "¡Listo! Descargando archivo..."
            content_out = output_io.getvalue()
            out_array = Uint8Array.new(len(content_out))
            out_array.assign(content_out)
            
            blob = File.new([out_array], "Reporte_Observaciones.xlsx", { "type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" })
            url = URL.createObjectURL(blob)
            
            link = document.createElement("a")
            link.href = url
            link.download = "Reporte_Ventas_Analizado.xlsx"
            link.click()
    </script>
</body>

</html>